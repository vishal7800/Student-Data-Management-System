<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard - Student Management System</title>
    <style>
* {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
    font-family: Arial, Helvetica, sans-serif;
}

body {
    background-color: #f4f6f9;
    color: #333;
    line-height: 1.6;
}

.navbar {
    background-color: #3f51b5;
    color: white;
    padding: 0 20px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

.navbar-container {
    display: flex;
    justify-content: space-between;
    align-items: center;
    max-width: 1200px;
    margin: 0 auto;
    height: 60px;
}

.logo {
    font-size: 22px;
    font-weight: bold;
}

.nav-links {
    display: flex;
}

.nav-link {
    color: white;
    text-decoration: none;
    padding: 10px 15px;
    margin: 0 5px;
    border-radius: 4px;
    font-size: 14px;
}

.nav-link.active {
    background-color: #303f9f;
}

.nav-link:hover {
    background-color: #5c6bc0;
}

.user-info {
    display: flex;
    align-items: center;
}

.user-name {
    margin-right: 15px;
}

.user-avatar {
    height: 35px;
    width: 35px;
    background-color: #303f9f;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 14px;
    font-weight: 500;
}

.main-container {
    max-width: 1200px;
    margin: 20px auto;
    padding: 0 20px;
}

.dashboard-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 20px;
}

.dashboard-title {
    font-size: 24px;
    font-weight: bold;
}

.date-display {
    font-size: 14px;
    color: #666;
}

.dashboard-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
    gap: 20px;
    margin-bottom: 30px;
}

.stat-card {
    background-color: white;
    border-radius: 8px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    padding: 15px;
    display: flex;
    align-items: center;
}

.stat-icon {
    width: 50px;
    height: 50px;
    border-radius: 8px;
    display: flex;
    align-items: center;
    justify-content: center;
    margin-right: 15px;
    color: white;
    font-size: 20px;
}

.stat-icon.blue {
    background-color: #2196f3;
}

.stat-icon.green {
    background-color: #4caf50;
}

.stat-icon.orange {
    background-color: #ff9800;
}

.stat-icon.red {
    background-color: #f44336;
}

.stat-content h3 {
    font-size: 14px;
    color: #666;
    margin-bottom: 5px;
}

.stat-content p {
    font-size: 22px;
    font-weight: bold;
}

.content-section {
    background-color: white;
    border-radius: 8px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    padding: 20px;
    margin-bottom: 20px;
}

.section-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 15px;
    padding-bottom: 10px;
    border-bottom: 1px solid #eee;
}

.section-title {
    font-size: 18px;
    font-weight: bold;
}

.attendance-form {
    display: flex;
    flex-wrap: wrap;
    gap: 15px;
    margin-bottom: 15px;
}

.form-group {
    flex: 1;
    min-width: 200px;
}

label {
    display: block;
    margin-bottom: 5px;
    font-size: 14px;
    color: #666;
}

select, input {
    width: 100%;
    padding: 8px 10px;
    border: 1px solid #ddd;
    border-radius: 4px;
    font-size: 14px;
}

button {
    background-color: #3f51b5;
    color: white;
    border: none;
    padding: 10px 15px;
    border-radius: 4px;
    cursor: pointer;
    font-size: 14px;
    transition: background-color 0.3s;
}

button:hover {
    background-color: #303f9f;
}

.attendance-table {
    width: 100%;
    border-collapse: collapse;
    margin-top: 15px;
}

.attendance-table th, 
.attendance-table td {
    border: 1px solid #ddd;
    padding: 10px;
    text-align: left;
}

.attendance-table th {
    background-color: #f2f2f2;
}

.attendance-table tr:nth-child(even) {
    background-color: #f9f9f9;
}

.attendance-checkbox {
    width: 18px;
    height: 18px;
    cursor: pointer;
}

.upload-form {
    display: flex;
    flex-direction: column;
    gap: 15px;
}

.file-upload {
    display: flex;
    flex-direction: column;
    gap: 10px;
}

.file-input-container {
    position: relative;
}

.file-input {
    opacity: 0;
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    cursor: pointer;
}

.file-input-label {
    display: flex;
    align-items: center;
    gap: 10px;
    padding: 10px;
    border: 1px dashed #3f51b5;
    border-radius: 4px;
    color: #3f51b5;
    font-size: 14px;
    cursor: pointer;
}

.file-input-label:hover {
    background-color: #f0f2ff;
}

textarea {
    width: 100%;
    padding: 10px;
    border: 1px solid #ddd;
    border-radius: 4px;
    resize: vertical;
    min-height: 100px;
}

.circular-list {
    margin-top: 20px;
}

.circular-item {
    display: flex;
    justify-content: space-between;
    align-items: center; 
    padding: 12px;
    border-bottom: 1px solid #eee;
}

.circular-item:last-child {
    border-bottom: none;
}

.circular-title {
    font-weight: 500;
}

.circular-date {
    font-size: 12px;
    color: #666;
}

.circular-actions a {
    margin-left: 10px;
    color: #3f51b5;
    text-decoration: none;
    cursor: pointer;
}

.circular-actions a:hover {
    text-decoration: underline;
}

.modal {
    display: none;
    position: fixed;
    z-index: 1000;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0,0,0,0.5);
    overflow: auto;
}

.modal-content {
    background-color: white;
    margin: 10% auto;
    padding: 20px;
    border-radius: 8px;
    width: 80%;
    max-width: 600px;
    box-shadow: 0 4px 8px rgba(0,0,0,0.2);
    position: relative;
}

.close {
    position: absolute;
    right: 20px;
    top: 15px;
    font-size: 24px;
    font-weight: bold;
    color: #666;
    cursor: pointer;
}

.close:hover {
    color: #333;
}

.modal h2 {
    margin-bottom: 20px;
    color: #3f51b5;
}

.modal-buttons {
    display: flex;
    justify-content: flex-end;
    gap: 10px;
    margin-top: 20px;
}

#confirmLogout {
    background-color: #f44336;
}

#confirmLogout:hover {
    background-color: #d32f2f;
}

#confirmDeleteBtn {
    background-color: #f44336;
}

#confirmDeleteBtn:hover {
    background-color: #d32f2f;
}

.circular-details {
    margin-bottom: 20px;
    padding: 15px;
    background-color: #f9f9f9;
    border-radius: 4px;
}

.circular-details p {
    margin-bottom: 10px;
    font-size: 14px;
}

#viewCircularDescription {
    margin-top: 15px;
    padding-top: 15px;
    border-top: 1px solid #eee;
}

.modal-footer {
    display: flex;
    justify-content: flex-end;
    margin-top: 20px;
}

@media (max-width: 768px) {
    .navbar-container {
        flex-direction: column;
        height: auto;
        padding: 10px 0;
    }
    
    .nav-links {
        margin: 10px 0;
        flex-wrap: wrap;
        justify-content: center;
    }
    
    .user-info {
        margin-top: 10px;
    }
    
    .dashboard-grid {
        grid-template-columns: 1fr;
    }
    
    .attendance-form {
        flex-direction: column;
    }
    
    .attendance-table {
        display: block;
        overflow-x: auto;
    }
    
    .modal-content {
        width: 95%;
        margin: 5% auto;
    }
}
    </style>
</head>
<body>
    <nav class="navbar">
        <div class="navbar-container">
            <div class="logo">UniMate</div>
            <div class="nav-links">
                <a href="#" class="nav-link active">Dashboard</a>
                <a href="#" class="nav-link">Students</a>
                <a href="#" class="nav-link">Classes</a>
                <a href="#" class="nav-link">Reports</a>
                <a href="#" class="nav-link">Settings</a>
            </div>
            <div class="user-info">
                <span class="user-name">Welcome, Vishal Mishra</span>
                <div class="user-avatar">VM</div>
            </div>
        </div>
    </nav>

    <div class="main-container">
        <div class="dashboard-header">
            <h1 class="dashboard-title">Admin Dashboard</h1>
            <div class="date-display" id="currentDate">Loading...</div>
        </div>

        <div class="dashboard-grid">
            <div class="stat-card">
                <div class="stat-icon blue">
                    <i>ðŸ‘¥</i>
                </div>
                <div class="stat-content">
                    <h3>Total Students</h3>
                    <p>1,254</p>
                </div>
            </div>
            <div class="stat-card">
                <div class="stat-icon green">
                    <i>âœ“</i>
                </div>
                <div class="stat-content">
                    <h3>Present Today</h3>
                    <p>1,087</p>
                </div>
            </div>
            <div class="stat-card">
                <div class="stat-icon orange">
                    <i>âœ—</i>
                </div>
                <div class="stat-content">
                    <h3>Absent Today</h3>
                    <p>167</p>
                </div>
            </div>
            <div class="stat-card">
                <div class="stat-icon red">
                    <i>ðŸ“ƒ</i>
                </div>
                <div class="stat-content">
                    <h3>Active Circulars</h3>
                    <p>12</p>
                </div>
            </div>
        </div>

        <div class="content-section">
            <div class="section-header">
                <h2 class="section-title">Attendance Management</h2>
                <button id="saveAttendanceBtn">Save Attendance</button>
            </div>
            
            <div class="attendance-form">
                <div class="form-group">
                    <label for="classSelect">Select Group</label>
                    <select id="classSelect">
                        <option value="">-- Select Group --</option>
                        <option value="G-1">Group 1</option>
                        <option value="G-2">Group 2</option>
                        <option value="G-3">Group 3</option>
                        <option value="G-4">Group 4</option>
                        <option value="G-5">Group 5</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="sectionSelect">Select Subject</label>
                    <select id="sectionSelect">
                        <option value="">-- Select Subject --</option>
                        <option value="DSA">DSA</option>
                        <option value="JAVA">JAVA</option>
                        <option value="BEE">BEE</option>
                        <option value="Linux">Linux</option>
                        <option value="IOT">IoT</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="dateSelect">Date</label>
                    <input type="date" id="dateSelect">
                </div>
                <div class="form-group">
                    <label>&nbsp;</label>
                    <button id="loadStudentsBtn">Load Students</button>
                </div>
            </div>
            
            <table class="attendance-table">
                <thead>
                    <tr>
                        <th>Roll No.</th>
                        <th>Student Name</th>
                        <th>Present</th>
                        <th>Absent</th>
                        <th>Leave</th>
                        <th>Notes</th>
                    </tr>
                </thead>
                <tbody id="attendanceTableBody">
                    <tr>
                        <td colspan="6" style="text-align: center;">Select a class and section to load students</td>
                    </tr>
                </tbody>
            </table>
        </div>

        <div class="content-section">
            <div class="section-header">
                <h2 class="section-title">Upload Circulars</h2>
            </div>
            
            <div class="upload-form">
                <div class="form-group">
                    <label for="circularTitle">Circular Title</label>
                    <input type="text" id="circularTitle" placeholder="Enter circular title">
                </div>
                
                <div class="form-group">
                    <label for="circularDescription">Description</label>
                    <textarea id="circularDescription" placeholder="Enter circular description"></textarea>
                </div>
                
                <div class="form-group file-upload">
                    <label>Attachment</label>
                    <div class="file-input-container">
                        <div class="file-input-label">
                            <span>ðŸ“Ž</span>
                            <span id="fileNameDisplay">No file chosen</span>
                        </div>
                        <input type="file" id="circularFile" class="file-input">
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="targetAudience">Target Audience</label>
                    <select id="targetAudience">
                        <option value="all">All Students</option>
                        <option value="G-1">Group 1</option>
                        <option value="G-2">Group 2</option>
                        <option value="G-3">Group 3</option>
                        <option value="G-4">Group 4</option>
                        <option value="G-5">Group 5</option>
                        <option value="teachers">Teachers Only</option>
                        <option value="parents">Parents Only</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <button id="uploadCircularBtn">Upload Circular</button>
                </div>
            </div>
            
            <div class="circular-list">
                <h3>Recent Circulars</h3>
                <div class="circular-item" data-id="1">
                    <div>
                        <div class="circular-title">Annual Sports Day Notice</div>
                        <div class="circular-date">April 5, 2025</div>
                    </div>
                    <div class="circular-actions">
                        <a href="#" class="view-circular">View</a>
                        <a href="#" class="edit-circular">Edit</a>
                        <a href="#" class="delete-circular">Delete</a>
                    </div>
                </div>
                <div class="circular-item" data-id="2">
                    <div>
                        <div class="circular-title">Final Exam Schedule</div>
                        <div class="circular-date">April 2, 2025</div>
                    </div>
                    <div class="circular-actions">
                        <a href="#" class="view-circular">View</a>
                        <a href="#" class="edit-circular">Edit</a>
                        <a href="#" class="delete-circular">Delete</a>
                    </div>
                </div>
                <div class="circular-item" data-id="3">
                    <div>
                        <div class="circular-title">Parent-Teacher Meeting</div>
                        <div class="circular-date">March 28, 2025</div>
                    </div>
                    <div class="circular-actions">
                        <a href="#" class="view-circular">View</a>
                        <a href="#" class="edit-circular">Edit</a>
                        <a href="#" class="delete-circular">Delete</a>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="viewCircularModal" class="modal">
        <div class="modal-content">
            <span class="close">&times;</span>
            <h2>Circular Details</h2>
            <div class="circular-details">
                <h3 id="viewCircularTitle"></h3>
                <p id="viewCircularDate"></p>
                <p id="viewCircularAudience"></p>
                <div id="viewCircularAttachment"></div>
                <div id="viewCircularDescription"></div>
            </div>
            <div class="modal-footer">
                <button id="closeViewModalBtn">Close</button>
            </div>
        </div>
    </div>

    <div id="editCircularModal" class="modal">
        <div class="modal-content">
            <span class="close">&times;</span>
            <h2>Edit Circular</h2>
            <div class="upload-form">
                <input type="hidden" id="editCircularId">
                <div class="form-group">
                    <label for="editCircularTitle">Circular Title</label>
                    <input type="text" id="editCircularTitle" placeholder="Enter circular title">
                </div>
                
                <div class="form-group">
                    <label for="editCircularDescription">Description</label>
                    <textarea id="editCircularDescription" placeholder="Enter circular description"></textarea>
                </div>
                
                <div class="form-group file-upload">
                    <label>Attachment</label>
                    <div class="file-input-container">
                        <div class="file-input-label">
                            <span>ðŸ“Ž</span>
                            <span id="editFileNameDisplay">No file chosen</span>
                        </div>
                        <input type="file" id="editCircularFile" class="file-input">
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="editTargetAudience">Target Audience</label>
                    <select id="editTargetAudience">
                        <option value="all">All Students</option>
                        <option value="G-1">Group 1</option>
                        <option value="G-2">Group 2</option>
                        <option value="G-3">Group 3</option>
                        <option value="G-4">Group 4</option>
                        <option value="G-5">Group 5</option>
                        <option value="teachers">Teachers Only</option>
                        <option value="parents">Parents Only</option>
                    </select>
                </div>
            </div>
            <div class="modal-buttons">
                <button id="cancelEditBtn">Cancel</button>
                <button id="saveEditBtn">Save Changes</button>
            </div>
        </div>
    </div>

    <div id="deleteCircularModal" class="modal">
        <div class="modal-content">
            <span class="close">&times;</span>
            <h2>Delete Circular</h2>
            <p>Are you sure you want to delete the circular "<span id="deleteCircularTitle"></span>"?</p>
            <p>This action cannot be undone.</p>
            <input type="hidden" id="deleteCircularId">
            <div class="modal-buttons">
                <button id="cancelDeleteBtn">Cancel</button>
                <button id="confirmDeleteBtn">Delete</button>
            </div>
        </div>
    </div>

    <script>
        const circulars = [
            {
                id: 1,
                title: "Annual Sports Day Notice",
                date: "April 5, 2025",
                description: "The Annual Sports Day will be held on April 20, 2025. All students are expected to participate in at least one event. Registration for various sports events will start from April 7, 2025. Please contact your class teacher for more details.",
                attachment: "sports_day_schedule.pdf",
                audience: "all"
            },
            {
                id: 2,
                title: "Final Exam Schedule",
                date: "April 2, 2025",
                description: "Final examinations for the current semester will commence from May 10, 2025. The detailed schedule has been attached. Students are advised to prepare accordingly and ensure they have no dues in the library or laboratory.",
                attachment: "exam_schedule.pdf",
                audience: "all"
            },
            {
                id: 3,
                title: "Parent-Teacher Meeting",
                date: "March 28, 2025",
                description: "A parent-teacher meeting has been scheduled for April 15, 2025, from 10:00 AM to 2:00 PM. All parents are requested to attend and discuss their ward's academic progress with respective faculty members.",
                attachment: "ptm_details.pdf",
                audience: "parents"
            }
        ];

        function setCurrentDate() {
            const now = new Date();
            const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
            document.getElementById('currentDate').textContent = now.toLocaleDateString('en-US', options);
            
            const dateInput = document.getElementById('dateSelect');
            if (dateInput) {
                const today = now.toISOString().split('T')[0];
                dateInput.value = today;
            }
        }
        async function loadStudents() {
    const classValue = document.getElementById('classSelect').value;
    const sectionValue = document.getElementById('sectionSelect').value;

    if (!classValue || !sectionValue) {
        alert('Please select both Class and Section');
        return;
    }

    const tableBody = document.getElementById('attendanceTableBody');
    tableBody.innerHTML = '';

    try {
        const response = await fetch(`http://localhost:3000/admin/students?groupNumber=${classValue}`);
        const students = await response.json();

        if (!students.length) {
            tableBody.innerHTML = `<tr><td colspan="6">No students found for this group.</td></tr>`;
            return;
        }

        students.forEach(student => {
            const row = document.createElement('tr');

            const rollCell = document.createElement('td');
            rollCell.textContent = student.rollNumber;
            row.appendChild(rollCell);

            const nameCell = document.createElement('td');
            nameCell.textContent = student.name || 'N/A'; 
            row.appendChild(nameCell);

            const presentCell = document.createElement('td');
            const presentInput = document.createElement('input');
            presentInput.type = 'radio';
            presentInput.name = `attendance_${student.rollNumber}`;
            presentInput.value = 'present';
            presentInput.checked = true;
            presentInput.className = 'attendance-checkbox';
            presentCell.appendChild(presentInput);
            row.appendChild(presentCell);

            const absentCell = document.createElement('td');
            const absentInput = document.createElement('input');
            absentInput.type = 'radio';
            absentInput.name = `attendance_${student.rollNumber}`;
            absentInput.value = 'absent';
            absentInput.className = 'attendance-checkbox';
            absentCell.appendChild(absentInput);
            row.appendChild(absentCell);

            const leaveCell = document.createElement('td');
            const leaveInput = document.createElement('input');
            leaveInput.type = 'radio';
            leaveInput.name = `attendance_${student.rollNumber}`;
            leaveInput.value = 'leave';
            leaveInput.className = 'attendance-checkbox';
            leaveCell.appendChild(leaveInput);
            row.appendChild(leaveCell);

            const notesCell = document.createElement('td');
            const notesInput = document.createElement('input');
            notesInput.type = 'text';
            notesInput.placeholder = 'Add notes (optional)';
            notesInput.style.width = '100%';
            notesInput.style.padding = '5px';
            notesInput.style.border = '1px solid #ddd';
            notesInput.style.borderRadius = '4px';
            notesCell.appendChild(notesInput);
            row.appendChild(notesCell);

            tableBody.appendChild(row);
        });

    } catch (err) {
        console.error('Failed to load students:', err);
        alert('Failed to load students from server.');
    }
}

        function handleFileSelect() {
            const fileInput = document.getElementById('circularFile');
            const fileNameDisplay = document.getElementById('fileNameDisplay');
            
            if (fileInput.files.length > 0) {
                fileNameDisplay.textContent = fileInput.files[0].name;
            } else {
                fileNameDisplay.textContent = 'No file chosen';
            }
        }

        function handleEditFileSelect() {
            const fileInput = document.getElementById('editCircularFile');
            const fileNameDisplay = document.getElementById('editFileNameDisplay');
            
            if (fileInput.files.length > 0) {
                fileNameDisplay.textContent = fileInput.files[0].name;
            } else {
                fileNameDisplay.textContent = 'No file chosen';
            }
        }
        
        function uploadCircular() {
            const title = document.getElementById('circularTitle').value;
            const description = document.getElementById('circularDescription').value;
            const file = document.getElementById('circularFile').files[0];
            const audience = document.getElementById('targetAudience').value;
            
            if (!title) {
                alert('Please enter a circular title');
                return;
            }
            
            alert(`Circular "${title}" uploaded successfully!`);
            
            const fileName = file ? file.name : 'No attachment';
            
            const newCircular = {
                id: circulars.length + 1,
                title: title,
                date: new Date().toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' }),
                description: description,
                attachment: fileName,
                audience: audience
            };

            circulars.unshift(newCircular);
            
            const circularList = document.querySelector('.circular-list');
            const circularItem = document.createElement('div');
            circularItem.className = 'circular-item';
            circularItem.setAttribute('data-id', newCircular.id);
            circularItem.innerHTML = `
    <div>
        <div class="circular-title">${newCircular.title}</div>
        <div class="circular-date">${newCircular.date}</div>
    </div>
    <div class="circular-actions">
        <a href="#" class="view-circular">View</a>
        <a href="#" class="edit-circular">Edit</a>
        <a href="#" class="delete-circular">Delete</a>
    </div>
`;
            
const firstItem = circularList.querySelector('.circular-item');
if (firstItem) {
    circularList.insertBefore(circularItem, firstItem);
} else {
    circularList.appendChild(circularItem);
}

document.getElementById('circularTitle').value = '';
document.getElementById('circularDescription').value = '';
document.getElementById('circularFile').value = '';
document.getElementById('fileNameDisplay').textContent = 'No file chosen';
document.getElementById('targetAudience').value = 'all';

addCircularEventListeners(circularItem);
}
function saveAttendance() {
    const classValue = document.getElementById('classSelect').value;
    const sectionValue = document.getElementById('sectionSelect').value;
    const dateValue = document.getElementById('dateSelect').value;

    if (!classValue || !sectionValue || !dateValue) {
        alert('Please select Class, Section and Date');
        return;
    }

    const rows = document.querySelectorAll('#attendanceTableBody tr');
    const attendance = [];

    rows.forEach(row => {
        const rollNumber = row.cells[0]?.textContent.trim();
        
        if (!rollNumber || rollNumber.includes('No students found')) return;
        
        const radioButtons = row.querySelectorAll('input[type="radio"]');
        let status = 'absent';
        
        radioButtons.forEach(radio => {
            if (radio.checked) {
                status = radio.value;
            }
        });
        
        const notesInput = row.querySelector('input[type="text"]');
        const notes = notesInput ? notesInput.value : '';

        attendance.push({ rollNumber, status, notes });
    });

    const attendanceData = {
        date: dateValue,
        subject: sectionValue,
        groupNumber: classValue,
        attendance: attendance
    };

    console.log('Saving attendance data:', attendanceData);

    fetch('http://localhost:3000/admin/saveAttendance', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(attendanceData)
    })
    .then(response => {
        if (!response.ok) throw new Error('Network response was not ok');
        return response.json();
    })
    .then(data => {
        alert('Attendance saved successfully!');
    })
    .catch(error => {
        console.error('Error saving attendance:', error);
        alert('Failed to save attendance.');
    });
}

function getAudienceDisplayName(audienceValue) {
    const audienceMap = {
        'all': 'All Students',
        'G-1': 'Group 1',
        'G-2': 'Group 2',
        'G-3': 'Group 3',
        'G-4': 'Group 4',
        'G-5': 'Group 5',
        'teachers': 'Teachers Only',
        'parents': 'Parents Only'
    };
    return audienceMap[audienceValue] || audienceValue;
}

function viewCircular(id) {
    const circular = circulars.find(c => c.id === parseInt(id));
    if (!circular) return;
    
    document.getElementById('viewCircularTitle').textContent = circular.title;
    document.getElementById('viewCircularDate').textContent = `Date: ${circular.date}`;
    document.getElementById('viewCircularAudience').textContent = `Target Audience: ${getAudienceDisplayName(circular.audience)}`;
    
    if (circular.attachment && circular.attachment !== 'No attachment') {
        document.getElementById('viewCircularAttachment').innerHTML = `
            <p>Attachment: <a href="#" style="color: #3f51b5;">${circular.attachment}</a></p>
        `;
    } else {
        document.getElementById('viewCircularAttachment').innerHTML = `<p>No attachment</p>`;
    }
    
    document.getElementById('viewCircularDescription').innerHTML = `
        <h4>Description:</h4>
        <p>${circular.description}</p>
    `;
    
    document.getElementById('viewCircularModal').style.display = 'block';
}

function editCircular(id) {
    const circular = circulars.find(c => c.id === parseInt(id));
    if (!circular) return;
    
    document.getElementById('editCircularId').value = circular.id;
    document.getElementById('editCircularTitle').value = circular.title;
    document.getElementById('editCircularDescription').value = circular.description;
    document.getElementById('editFileNameDisplay').textContent = circular.attachment || 'No file chosen';
    document.getElementById('editTargetAudience').value = circular.audience;
    
    document.getElementById('editCircularModal').style.display = 'block';
}

function saveEditedCircular() {
    const id = parseInt(document.getElementById('editCircularId').value);
    const title = document.getElementById('editCircularTitle').value;
    const description = document.getElementById('editCircularDescription').value;
    const fileInput = document.getElementById('editCircularFile');
    const audience = document.getElementById('editTargetAudience').value;
    
    if (!title) {
        alert('Please enter a circular title');
        return;
    }
    
    const circularIndex = circulars.findIndex(c => c.id === id);
    if (circularIndex === -1) return;
    
    let fileName = circulars[circularIndex].attachment;
    if (fileInput.files.length > 0) {
        fileName = fileInput.files[0].name;
    }
    
    circulars[circularIndex] = {
        ...circulars[circularIndex],
        title: title,
        description: description,
        attachment: fileName,
        audience: audience
    };
    
    const circularItem = document.querySelector(`.circular-item[data-id="${id}"]`);
    if (circularItem) {
        circularItem.querySelector('.circular-title').textContent = title;
    }
    
    document.getElementById('editCircularModal').style.display = 'none';
    
    alert(`Circular "${title}" updated successfully!`);
}

function deleteCircular(id) {
    const circular = circulars.find(c => c.id === parseInt(id));
    if (!circular) return;
    
    document.getElementById('deleteCircularId').value = circular.id;
    document.getElementById('deleteCircularTitle').textContent = circular.title;
    document.getElementById('deleteCircularModal').style.display = 'block';
}

function confirmDeleteCircular() {
    const id = parseInt(document.getElementById('deleteCircularId').value);
    
    const circularIndex = circulars.findIndex(c => c.id === id);
    if (circularIndex !== -1) {
        circulars.splice(circularIndex, 1);
    }
    
    const circularItem = document.querySelector(`.circular-item[data-id="${id}"]`);
    if (circularItem) {
        circularItem.remove();
    }
    
    document.getElementById('deleteCircularModal').style.display = 'none';
    
    alert('Circular deleted successfully!');
}

function addCircularEventListeners(circularItem) {
    const id = circularItem.getAttribute('data-id');
    
    const viewLink = circularItem.querySelector('.view-circular');
    const editLink = circularItem.querySelector('.edit-circular');
    const deleteLink = circularItem.querySelector('.delete-circular');
    
    viewLink.addEventListener('click', function(e) {
        e.preventDefault();
        viewCircular(id);
    });
    
    editLink.addEventListener('click', function(e) {
        e.preventDefault();
        editCircular(id);
    });
    
    deleteLink.addEventListener('click', function(e) {
        e.preventDefault();
        deleteCircular(id);
    });
}

document.addEventListener('DOMContentLoaded', function() {
    setCurrentDate();
    
    document.getElementById('loadStudentsBtn').addEventListener('click', loadStudents);
    document.getElementById('circularFile').addEventListener('change', handleFileSelect);
    document.getElementById('uploadCircularBtn').addEventListener('click', uploadCircular);
    document.getElementById('saveAttendanceBtn').addEventListener('click', saveAttendance);
    document.getElementById('editCircularFile').addEventListener('change', handleEditFileSelect);
    
    document.querySelectorAll('.circular-item').forEach(function(item) {
        addCircularEventListeners(item);
    });
    
    document.querySelectorAll('.close, #closeViewModalBtn').forEach(function(closeBtn) {
        closeBtn.addEventListener('click', function() {
            document.querySelectorAll('.modal').forEach(function(modal) {
                modal.style.display = 'none';
            });
        });
    });
    
    document.getElementById('cancelEditBtn').addEventListener('click', function() {
        document.getElementById('editCircularModal').style.display = 'none';
    });
    
    document.getElementById('saveEditBtn').addEventListener('click', saveEditedCircular);
    
    document.getElementById('cancelDeleteBtn').addEventListener('click', function() {
        document.getElementById('deleteCircularModal').style.display = 'none';
    });
    
    document.getElementById('confirmDeleteBtn').addEventListener('click', confirmDeleteCircular);

    window.addEventListener('click', function(event) {
        document.querySelectorAll('.modal').forEach(function(modal) {
            if (event.target === modal) {
                modal.style.display = 'none';
            }
        });
    });
});
</script>
</body>
</html>